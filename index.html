<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 2 - Trade Explorer</title>
</head>

<body>
  <h1>Project 2 - Trade Explorer</h1>
  <div id="map1">
    <h3>Highest export chart</h3>
    <svg id="highest-export" width="960" height="500"></svg>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>
      async function loadData() {
        const export_data = await d3.csv('data/34_years_world_export_import_dataset.csv');
        const world_data = await d3.json('https://unpkg.com/world-atlas@1/world/110m.json');

        console.log(export_data);

        const countries = topojson.feature(world_data, world_data.objects.countries).features;

        const cleanedData = export_data.map(d => ({
          country: d.PartnerName ? d.PartnerName.trim().toLowerCase() : 'unknown',
          year: +d.Year,
          export: +d["Export(US$ Thousand)"] || 0
        }));

        const svg = d3.select("#highest-export");
        const width =+svg.attr("width");
        const height =+svg.attr("height");

        const colorScale = d3.scaleLinear()
          .domain([0, 9])
          .range(["lightgreen", "green"]);
        const latestYear = d3.max(cleanedData, d => d.year);
        const exportsByYear = cleanedData.filter(d => d.year === latestYear);

        const topExporters = exportsByYear.sort((a, b) => b.export - a.export).slice(0, 10);

        const projection = d3.geoMercator().scale(150).translate([width/2, height/1.5]);
        const path = d3.geoPath().projection(projection);

        const tooltip = d3.select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

        svg.append("g")
          .selectAll("path")
          .data(countries)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", d => {
            const countryName = d.properties.name ? d.properties.name.toLowerCase() : 'unknown';
            const exporter = topExporters.find(e => e.country === countryName);
            return exporter ? colorScale(topExporters.indexOf(exporter)) : "red";
          })
          .attr("stroke", "white")
          .on("mouseover", function (event, d) {
            const countryName = d.properties.name ? d.properties.name.toLowerCase() : 'unknown';
            const exporter = exportsByYear.find(e => e.country === countryName);
            const exportValue = exporter ? `$${exporter.export}` : "No data";

            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip.html(`<strong>${d.properties.name || "Unknown"}</strong><br>Export: ${exportValue}`)
              .style("left", (event.pageX + 5) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", function () {
            tooltip.transition().duration(200).style("opacity", 0);
          })
          .on("click", function (event, d) {
            const countryName = d.properties.name ? d.properties.name.toLowerCase() : 'unknown';
            console.log("Country:", countryName);
            const exporter = exportsByYear.find(e => e.country === countryName);
            const exportValue = exporter ? exporter.export : 0;

            svg.selectAll(".country-export-text").remove();

            svg.append("text")
              .attr("x", event.offsetX)
              .attr("y", event.offsetY)
              .attr("class", "country-export-text")
              .attr("fill", "black")
              .attr("font-size", "14px")
              .attr("font-weight", "bold")
              .attr("text-anchor", "middle")
              .text(`${d.properties.name || "Unknown"}: $${exportValue}`);
          });

        const years = Array.from(new Set(cleanedData.map(d => d.year)));

        const slider = d3.select("#map1")
          .append("input")
          .attr("type", "range")
          .attr("min", d3.min(years))
          .attr("max", d3.max(years))
          .attr("value", d3.min(years))
          .style("width", "960px")
          .on("input", function () {
            const selectedYear = +this.value; 
            d3.select("#selected-year").text(selectedYear); 
            updateMap(selectedYear); 
          });

        d3.select("#map1")
          .append("h4")
          .attr("id", "selected-year")
          .text(d3.min(years));

        function updateMap(year) {
          const exportsByYear = cleanedData
            .filter(d => d.year === year)
            .map(d => ({
              country: d.country.toLowerCase(),
              export: d.export
            }));

          const topExportersByYear = exportsByYear
            .sort((a, b) => b.export - a.export)
            .slice(0, 10);

          svg.selectAll("path")
            .attr("fill", d => {
              const countryName = d.properties.name ? d.properties.name.toLowerCase() : 'unknown';
              const exporter = topExportersByYear.find(e => e.country === countryName);
              return exporter ? colorScale(topExportersByYear.indexOf(exporter)) : "red";
            });
        }

        updateMap(d3.min(years));
      }

      loadData();
    </script>

  </div>

  <div id="map2">
    <h3>US export chart</h3>
    <svg id="overtime-greatest-export-chart" width="960" height="500"></svg>
    <script>
      async function loadData() { }



      loadData();
    </script>
  </div>

</body>

</html>
