<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 2 - Trade Explorer</title>
</head>

<body>
  <h1>Project 2 - Trade Explorer</h1>
  <!-- Reference map: https://observablehq.com/@d3/world-tour -->
  <!-- https://observablehq.com/@d3/web-mercator-tiles -->
  <!-- https://d3js.org/d3-geo/cylindrical -->


  <!-- 
  <div id="map1">
    <h3>Highest export chart</h3>
    <svg id="highest-export" width="960" height="500"></svg>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>
      async function loadData() {
        // Load data files with error handling
        const Data = await d3.csv('data/34_years_world_export_import_dataset.csv')
          .catch(err => console.error("Error loading Dataset1:", err));
        const Data2 = await d3.csv('data/34_years_world_export_import_dataset2.csv')
          .catch(err => console.error("Error loading Dataset2:", err));

        // Validate if datasets are loaded properly
        if (!Data || !Data2) {
          console.error("One or both datasets failed to load.");
          return;
        }

        console.log("Dataset1 Loaded:", Data);
        console.log("Dataset2 Loaded:", Data2);

        // Combine datasets (assuming rows align by index)
        const combinedData = Data.map((exportRow, index) => ({
          ...exportRow,
          ...Data2[index]
        }));

        console.log("Combined Data:", combinedData);

        // Setup SVG dimensions
        const svg = d3.select('#highest-export');
        const width = +svg.attr('width');
        const height = +svg.attr('height');

        // Load world map
        const world = await d3.json('https://unpkg.com/world-atlas@1/world/110m.json');
        const countries = topojson.feature(world, world.objects.countries);
        console.log("Countries:", countries);

        // Color scale for top 10 exporters
        const colorScale = d3.scaleLinear()
          .domain([0, 9])
          .range(["lightgreen", "green"]);

        // Get available years and default to the first
        const years = Array.from(new Set(combinedData.map(d => d.Year)));
        const year = years[0];

        // Filter data for the selected year
        const exportsByCountry = combinedData
          .filter(d => d.Year == year)
          .map(d => ({
            country: parseCountryName(d.PartnerName),
            export: +d["Export(US$ Thousand)"] || 0
          }));
        console.log("Exports by Country:", exportsByCountry);

        // Sort and select the top 10 exporters, remove regions like "World", "EU", "europe & central asia",
        // north america, east asia & pacific.
        const topExporters = exportsByCountry
          .filter(e => !["world", "eu", "europe & central asia", "north america", "east asia & pacific", "middle east & north afric", " world", "middle east & north africa"].includes(e.country))
          .sort((a, b) => b.export - a.export)
          .slice(0, 10);
        console.log("Top Exporters:", topExporters);

        // Draw the world map
        svg.append("g")
          .selectAll("path")
          .data(countries.features)
          .enter().append("path")
          .attr("d", path)
          .attr("fill", d => {
            const countryName = d.properties.name ? d.properties.name : '';
            const exporter = exportsByCountry.find(e => e.country === countryName);
            if (exporter) {
              const rank = topExporters.findIndex(e => e.country === countryName);
              return rank >= 0 ? colorScale(rank) : "lightgray";
            }
            return "red";
          })
          .attr("stroke", "white")
          .attr("id", d => d.properties.name)
          .on("click", (event, d) => {
            const countryName = d.properties.name ? d.properties.name.toLowerCase() : '';
            const exporter = exportsByCountry.find(e => e.country === countryName);
            const exportValue = exporter ? exporter.export : 0;

            // Remove previous annotations
            svg.selectAll(".country-export-text").remove();

            // Display country export information
            svg.append("text")
              .attr("x", event.offsetX)
              .attr("y", event.offsetY)
              .attr("class", "country-export-text")
              .attr("fill", "black")
              .attr("font-size", "14px")
              .attr("font-weight", "bold")
              .attr("text-anchor", "middle")
              .text(`${d.properties.name}: $${exportValue}`);
          });

        // Add year slider
        const slider = d3.select("#map1")
          .append("input")
          .attr("type", "range")
          .attr("min", 0)
          .attr("max", years.length - 1)
          .attr("value", 0)
          .style("width", "960px")
          .on("input", function () {
            const selectedYear = years[this.value];
            d3.select("h4").text(selectedYear);
            updateMap(selectedYear);
          });

        // Year label
        d3.select("#map1")
          .append("h4")
          .text(year);

        // Update map based on selected year
        function updateMap(year) {
          const exportsByYear = combinedData
            .filter(d => d.Year == year)
            .map(d => ({
              country: parseCountryName(d.PartnerName),
              export: +d["Export(US$ Thousand)"] || 0
            }));

          const topExportersByYear = exportsByYear
            .sort((a, b) => b.export - a.export)
            .slice(0, 10);

          svg.selectAll("path")
            .attr("fill", d => {
              const countryName = d.properties.name ? d.properties.name.toLowerCase() : '';
              const exporter = topExportersByYear.find(e => e.country === countryName);
              if (exporter) {
                const rank = topExportersByYear.findIndex(e => e.country === countryName);
                return colorScale(rank);
              }
              return "red";
            });
        }

        // Normalize country names
        function parseCountryName(name) {
          const countryMapping = {
            "united states": "united states of america",
            "us": "united states of america",
            "south korea": "korea, republic of",
            "united kingdom": "united kingdom of great britain and northern ireland"
          };
          return countryMapping[name.toLowerCase()] || name.toLowerCase();
        }

        // Initialize map with the first year
        updateMap(year);

      }

      loadData();
    </script>
  </div> -->


  <div id="map1">
    <h3>Highest export chart</h3>
    <svg id="highest-export" width="960" height="600"></svg>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>
      async function loadData() {

        // Load data files
        const Data = await d3.csv('data/trade_1988_2021.csv');
        console.log("Data:", Data);

        //CLean data set and remove unwanted data
        const cleanData = Data.filter(d => d['TradeFlowName'] === 'Export' && d
        ['PartnerName'] !== 'World' &&
          d['PartnerName'] !== 'Europe & Central Asia' &&
          d['PartnerName'] !== 'North America' &&
          d['PartnerName'] !== 'East Asia & Pacific' &&
          d['PartnerName'] !== 'Middle East & North Africa' &&
          d['PartnerName'] !== 'Middle East & North Africa');

        console.log("Clean Data:", cleanData);

        // Sum all the export values per year and group by reporter name
        const sumData = d3.rollup(cleanData, v =>
          d3.sum(v, d => d['TradeValue in 1000 USD']), d => d['Year'], d => d['ReporterName']);


        console.log("Sum Data:", sumData);

        // Get the top 10 reporters per year based on export value. 
        // ReporterName  = country, indicator some = TradeValue in 1000 USD
        const topExporters = Array.from(sumData, ([year, reporters]) => ({
          year,
          reporters: Array.from(reporters, ([reporter, value]) => ({
            reporter,
            value
          }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 10)

        }));


        // Update map based on selected year, return top exporters by year
        // filter every country export to the selected year
        function updateMap(year) {
          const countriesthisYear = sumData.get(year);
          console.log("Countries this year:", countriesthisYear);

          currentExporters = countriesthisYear ? Array.from(countriesthisYear, ([reporter, value]) => ({ reporter, value })) : [];

          // Identify the top 10 exporters
          currentExporters = currentExporters.sort((a, b) => b.value - a.value).slice(0, 10);

          // green color scale on top 10 exporters per year
          // color scale for top 10 exporters
          // Update map color
          g.selectAll('path')
            .attr('fill', d => {
              const countryName = d.properties.name;
              const exporterIndex = currentExporters.findIndex(e => e.reporter === countryName);
              return exporterIndex >= 0 ? colorScale(exporterIndex) : 'lightgrey';
            });

        }

        console.log("Top Exporters:", topExporters);

        // Setup SVG dimensions and draw world map
        const svg = d3.select('#highest-export');
        const width = +svg.attr('width');
        const height = +svg.attr('height');
        const g = svg.append('g');
        const projection = d3.geoMercator()
          .scale(140).translate([width / 2, height / 1.4]);
        const path = d3.geoPath(projection);
        const colorScale = d3.scaleLinear().domain([0, 9]).range(["lightgreen", "green"]);


        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
          .then(data => {
            const countries = topojson.feature(data, data.objects.countries);
            console.log("Countries:", countries);
            g.selectAll('path').data(countries.features)
              .enter().append('path')
              .attr('class', 'country')
              .attr('d', path)
              .attr('stroke', 'white')
              .on("mouseover", function (event, d) {
                const countryName = d.properties.name;
                console.log("Country:", countryName);
                const exporter = (sumData.get(year)).find(countryName);
                console.log("currentexporter:", currentExporters);
                console.log("Exporter:", exporter);


                svg.append('g').selectAll('*').remove(); // Clear any existing tooltip text
                svg.append('g').append('text')
                  .attr('x', event.offsetX)
                  .attr('y', event.offsetY - 10)
                  .attr('fill', 'black')
                  .attr('font-size', '12px')
                  .attr('font-weight', 'bold')
                  .text(`${countryName}: $${d3.format(",.1f")(exporter.value)}`);

              })
              .on("mouseout", function () {
                svg.append('g')
                  .selectAll('*').remove(); // Remove tooltip 
              })
          });
        // .append("title")
        // .text(d => d.properties.name);


        // slider for year selection
        const slider = d3.select("#map1")
          .append("input")
          .attr("type", "range")
          .attr("min", 1988)
          .attr("max", 2021)
          .attr("value", 1988)
          .style("width", "960px")
          .on("input", function () {
            const selectedYear = this.value;
            d3.select("h4").text(selectedYear);
            updateMap(selectedYear);
            d3.select("#map1").append("h4").attr("id", selectedYear);
          })

        // Initialize map  first year
        updateMap(1988);

      }


      loadData();
    </script>

  </div>
















  <div id="map2">
    <h3>US export chart</h3>
    <svg id="overtime-greatest-export-chart" width="960" height="500"></svg>
    <script>
      async function loadData() { }



      loadData();
    </script>
  </div>

</body>

</html>