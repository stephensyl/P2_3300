<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 2 - Trade Explorer</title>
</head>

<body>
  <h1>Project 2 - Trade Explorer</h1>
  <!-- Reference map: https://observablehq.com/@d3/world-tour -->
  <!-- https://observablehq.com/@d3/web-mercator-tiles -->
  <!-- https://d3js.org/d3-geo/cylindrical -->

  <div id="map1">
    <h3>Highest export chart</h3>
    <svg id="highest-export" width="960" height="600"></svg>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>
      async function loadData() {

        //Load data files;
        const Data = await d3.csv('data/trade_1988_2021.csv');
        console.log("Data:", Data);

        //CLean data set and remove unwanted data
        const cleanData = Data.filter(d => d['TradeFlowName'] === 'Export' && d
        ['PartnerName'] !== 'World' &&
          d['PartnerName'] !== 'Europe & Central Asia' &&
          d['PartnerName'] !== 'North America' &&
          d['PartnerName'] !== 'East Asia & Pacific' &&
          d['PartnerName'] !== 'Middle East & North Africa' &&
          d['PartnerName'] !== 'Middle East & North Africa');

        console.log("Clean Data:", cleanData);

        // adding all of the export values in each year and grouping them by reporter's name
        const sumData = d3.rollup(cleanData, v =>
          d3.sum(v, d => d['TradeValue in 1000 USD']), d => d['Year'], d => d['ReporterName']);


        console.log("Sum Data:", sumData);

        const topExporters = Array.from(sumData, ([year, reporters]) => ({
          year,
          reporters: Array.from(reporters, ([reporter, value]) => ({
            reporter,
            value
          }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 10)

        }));

        function updateMap(year) {
          const countriesthisYear = sumData.get(year);
          console.log("Countries this year:", countriesthisYear);

          currentExporters = countriesthisYear ? Array.from(countriesthisYear, ([reporter, value]) => ({ reporter, value })) : [];
          currentExporters = currentExporters.sort((a, b) => b.value - a.value).slice(0, 10);

          g.selectAll('path')
            .attr('fill', d => {
              const countryName = d.properties.name;
              const exporterIndex = currentExporters.findIndex(e => e.reporter === countryName);
              return exporterIndex >= 0 ? colorScale(exporterIndex) : 'lightgrey';
            });

        }

        console.log("Top Exporters:", topExporters);

        // need to download world map here
        const svg = d3.select('#highest-export');
        const width = +svg.attr('width');
        const height = +svg.attr('height');
        const g = svg.append('g');
        const projection = d3.geoMercator()
          .scale(140).translate([width / 2, height / 1.4]);
        const path = d3.geoPath(projection);
        const colorScale = d3.scaleLinear().domain([0, 9]).range(["lightgreen", "green"]);


        d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
          .then(data => {
            const countries = topojson.feature(data, data.objects.countries);
            console.log("Countries:", countries);
            g.selectAll('path').data(countries.features)
              .enter().append('path')
              .attr('class', 'country')
              .attr('d', path)
              .attr('stroke', 'white')
              .on("mouseover", function (event, d) {
                const countryName = d.properties.name;
                const exporter = currentExporters.find(e => e.reporter === countryName);

                if (exporter) {
                  const tooltip = d3.select('body').selectAll('.tooltip')
                    .data([exporter])
                    .join('div')
                    .attr('class', 'tooltip')
                    .style('position', 'absolute')
                    .style('background-color', 'white')
                    .style('border', 'solid')
                    .style('border-width', '1px')
                    .style('border-radius', '5px')
                    .style('padding', '10px')
                    .style('pointer-events', 'none')
                    .style('opacity', 0);

                  tooltip.transition()
                    .duration(200)
                    .style('opacity', .9);

                  tooltip.text(`${countryName}: $${d3.format(",.1f")(exporter.value)}`)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
                }

              })
              .on("mouseout", function () {
                d3.select('.tooltip').remove(); // remove tooltip
              });
          });
        // .append("title")
        // .text(d => d.properties.name);


        //update: its working now - slider for year selection
        const slider = d3.select("#map1")
          .append("input")
          .attr("type", "range")
          .attr("min", 1988)
          .attr("max", 2021)
          .attr("value", 1988)
          .style("width", "960px")
          .on("input", function () {
            const selectedYear = this.value;
            d3.select("h4").text(selectedYear);
            updateMap(selectedYear);
            d3.select("#map1").append("h4").attr("id", selectedYear);
          })
        updateMap(1988);

      }


      loadData();
    </script>

  </div>


  <center>
    <div id="map2">
      <h3>US Export Trends Over Time (1988-2021)</h3>
      <svg id="overtime-greatest-export-chart" width="960" height="500"></svg>
      <script>
        async function loadData() { }



        loadData();
      </script>
    </div>
  </center>

</body>

</html>